{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Бой - {{ state.monster.name }}</title>
    <link rel="stylesheet" href="{% static 'css/combat.css' %}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="combat-page">
    <div class="combat-container">
        <!-- Верхняя панель (Header) -->
        <div class="combat-top-panel">
            <div class="fighter-stats player-stats">
                <div class="name">{{ state.player.name }} [{{ state.player.level }}] <img src="{% static 'img/info.png' %}" class="info-icon"></div>
                <div class="hp-container">
                    <div id="player-hp-bar" class="hp-bar" style="width: {{ player_hp_percent }}%;"></div>
                    <div id="player-hp-text" class="hp-text">{{ state.player.current_hp }}/{{ state.player.max_hp }}</div>
                </div>
            </div>

            <div class="combat-title">Поединок</div>

            <div class="fighter-stats monster-stats">
                <div class="hp-container">
                    <div id="monster-hp-bar" class="hp-bar" style="width: {{ monster_hp_percent }}%;"></div>
                    <div id="monster-hp-text" class="hp-text">{{ state.monster.current_hp }}/{{ state.monster.max_hp }}</div>
                </div>
                <div class="name">{{ state.monster.name }} [{{ state.monster.level }}] <img src="{% static 'img/info.png' %}" class="info-icon"></div>
            </div>
        </div>

        <div class="combat-main-grid">
            <!-- Левая колонка: Игрок -->
            <div class="side-panel player-side">
                <div class="avatar-box">
                    <img src="{% static 'img/obraz/skin.png' %}" alt="Player" class="avatar">
                </div>
                <!-- Слоты экипировки (имитация) -->
                <div class="equip-slots-left">
                    <div class="slot"></div><div class="slot"></div><div class="slot"></div>
                    <div class="slot"></div><div class="slot"></div><div class="slot"></div>
                </div>
            </div>

            <!-- Центральная колонка: Управление -->
            <div class="center-panel">
                <div class="controls-box" id="combat-controls">
                    <div class="selection-columns">
                        <div class="atk-selection">
                            <div class="selection-title">Атака</div>
                            <label><input type="radio" name="attack" value="1" checked> удар в голову</label>
                            <label><input type="radio" name="attack" value="2"> удар в грудь</label>
                            <label><input type="radio" name="attack" value="3"> удар в живот</label>
                            <label><input type="radio" name="attack" value="4"> удар в пояс(пах)</label>
                            <label><input type="radio" name="attack" value="5"> удар по ногам</label>
                        </div>
                        <div class="def-selection">
                            <div class="selection-title">Защита</div>
                            <label><input type="radio" name="defense" value="1" checked> блок головы, груди и живота</label>
                            <label><input type="radio" name="defense" value="2"> блок груди, живота и пояса</label>
                            <label><input type="radio" name="defense" value="3"> блок живота, пояса и ног</label>
                            <label><input type="radio" name="defense" value="4"> блок пояса, ног и головы</label>
                            <label><input type="radio" name="defense" value="5"> блок ног, головы и груди</label>
                        </div>
                    </div>
                    <div class="action-row">
                        <button id="btn-hit" class="hit-button">Вперёд!!!</button>
                    </div>
                </div>

                <div class="damage-counter">
                    На данный момент вами нанесено урона: <span id="total-damage-dealt">0</span> HP.
                </div>
            </div>

            <!-- Правая колонка: Противник -->
            <div class="side-panel monster-side">
                <div class="avatar-box">
                    <img src="{% static 'img/obraz/skin.png' %}" alt="Monster" class="avatar">
                </div>
                <div class="equip-slots-right">
                    <div class="slot"></div><div class="slot"></div><div class="slot"></div>
                    <div class="slot"></div><div class="slot"></div><div class="slot"></div>
                </div>
            </div>
        </div>

        <!-- Нижняя часть: Лог -->
        <div class="combat-footer">
            <div class="log-header">
                <span>Лог боя &raquo;</span>
            </div>
            <div id="combat-log" class="combat-log-content">
                {% for entry in state.log reversed %}
                    <div class="log-entry">{{ entry }}</div>
                {% endfor %}
            </div>
        </div>

        <div id="battle-end-modal" class="modal" style="display:none;">
            <div class="modal-content">
                <h2 id="modal-title">Бой завершен</h2>
                <p id="modal-message"></p>
                <button onclick="window.location.href='/game/'">Вернуться в игру</button>
            </div>
        </div>
    </div>

    <script>
        const combatId = "{{ combat_id }}";
        let totalDmg = 0;

        $(document).ready(function() {
            $('#btn-hit').on('click', function() {
                const attackZone = $('input[name="attack"]:checked').val();
                const defenseBlock = $('input[name="defense"]:checked').val();

                $(this).prop('disabled', true);

                $.ajax({
                    url: `/api/combat/${combatId}/turn/`,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        attack_zone: attackZone,
                        defense_block: defenseBlock
                    }),
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    success: function(response) {
                        updateCombatUI(response.state);
                        $('#btn-hit').prop('disabled', response.state.status !== 'active');
                    },
                    error: function(xhr) {
                        alert(xhr.responseJSON?.error || "Ошибка при выполнении хода");
                        $('#btn-hit').prop('disabled', false);
                    }
                });
            });
        });

        function updateCombatUI(state) {
            // HP Bars
            const playerHpPercent = (state.player.current_hp / state.player.max_hp) * 100;
            const monsterHpPercent = (state.monster.current_hp / state.monster.max_hp) * 100;

            $('#player-hp-bar').css('width', playerHpPercent + '%');
            $('#player-hp-text').text(`${state.player.current_hp}/${state.player.max_hp}`);

            $('#monster-hp-bar').css('width', monsterHpPercent + '%');
            $('#monster-hp-text').text(`${state.monster.current_hp}/${state.monster.max_hp}`);

            // Log
            $('#combat-log').empty();
            [...state.log].reverse().forEach(entry => {
                $('#combat-log').append(`<div class="log-entry">${entry}</div>`);

                // Простейший подсчет урона игрока для счетчика (можно сделать точнее на бэкенде)
                if (entry.includes('Игрок ударил') && entry.includes('на -')) {
                    const match = entry.match(/на -(\d+) HP/);
                    if (match) {
                        // Это не совсем правильно при обновлении всего лога, но для демки сойдет
                    }
                }
            });

            // Status check
            if (state.status !== 'active') {
                $('#combat-controls').hide();
                $('#modal-title').text(state.status === 'victory' ? 'Победа!' : 'Поражение');
                $('#modal-message').text(state.finish_message || "Бой окончен.");
                $('#battle-end-modal').show();
            }
        }
    </script>
</body>
</html>
