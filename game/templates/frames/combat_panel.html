{% load static %}
<div class="combat-container" id="combat-panel-container" style="display: none;">
    <!-- Верхняя панель (Header) -->
    <div class="combat-top-panel">
        <div class="fighter-stats player-stats">
            <div class="name" id="cp-player-name">Игрок [0] <img src="{% static 'img/info.png' %}" class="info-icon"></div>
            <div class="hp-container">
                <div id="cp-player-hp-bar" class="hp-bar" style="width: 100%;"></div>
                <div id="cp-player-hp-text" class="hp-text">0/0</div>
            </div>
        </div>

        <div class="combat-title">Поединок</div>

        <div class="fighter-stats monster-stats">
            <div class="hp-container">
                <div id="cp-monster-hp-bar" class="hp-bar" style="width: 100%;"></div>
                <div id="cp-monster-hp-text" class="hp-text">0/0</div>
            </div>
            <div class="name" id="cp-monster-name">Монстр [0] <img src="{% static 'img/info.png' %}" class="info-icon"></div>
        </div>
    </div>

    <div class="combat-main-grid">
        <!-- Левая колонка: Игрок -->
        <div class="side-panel player-side">
            <div class="avatar-box">
                <img src="{% static 'img/obraz/skin.png' %}" alt="Player" class="avatar">
            </div>
            <div class="equip-slots-left">
                <div class="slot"></div><div class="slot"></div><div class="slot"></div>
                <div class="slot"></div><div class="slot"></div><div class="slot"></div>
            </div>
        </div>

        <!-- Центральная колонка: Управление -->
        <div class="center-panel">
            <div class="controls-box" id="cp-combat-controls">
                <div class="selection-columns">
                    <div class="atk-selection">
                        <div class="selection-title">Атака</div>
                        <label><input type="radio" name="cp-attack" value="1" checked> удар в голову</label>
                        <label><input type="radio" name="cp-attack" value="2"> удар в корпус</label>
                        <label><input type="radio" name="cp-attack" value="3"> удар в пояс</label>
                        <label><input type="radio" name="cp-attack" value="4"> удар по ногам</label>
                    </div>
                    <div class="def-selection">
                        <div class="selection-title">Защита (выберите 2)</div>
                        <label><input type="checkbox" name="cp-defense" value="1"> блок головы</label>
                        <label><input type="checkbox" name="cp-defense" value="2"> блок корпуса</label>
                        <label><input type="checkbox" name="cp-defense" value="3"> блок пояса</label>
                        <label><input type="checkbox" name="cp-defense" value="4"> блок ног</label>
                    </div>
                </div>
                <div class="action-row">
                    <button id="cp-btn-hit" class="hit-button">Вперёд!!!</button>
                    <button id="cp-btn-flee" class="flee-button">Бежать</button>
                </div>
            </div>

            <div class="damage-counter">
                На данный момент вами нанесено урона: <span id="cp-total-damage-dealt">0</span> HP.
            </div>
        </div>

        <!-- Правая колонка: Противник -->
        <div class="side-panel monster-side">
            <div class="avatar-box">
                <img src="{% static 'img/obraz/skin.png' %}" alt="Monster" class="avatar">
            </div>
            <div class="equip-slots-right">
                <div class="slot"></div><div class="slot"></div><div class="slot"></div>
                <div class="slot"></div><div class="slot"></div><div class="slot"></div>
            </div>
        </div>
    </div>

    <!-- Нижняя часть: Лог -->
    <div class="combat-footer">
        <div class="log-header">
            <span>Лог боя &raquo;</span>
        </div>
        <div id="cp-combat-log" class="combat-log-content">
        </div>
    </div>
</div>

<script>
    let currentCombatId = null;

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function openCombatPanel(combatId) {
        currentCombatId = combatId;
        fetch(`/api/combat/${combatId}/state/`)
            .then(response => response.json())
            .then(data => {
                updateCPCombatUI(data.state);
                document.getElementById('combat-panel-container').style.display = 'block';
                // Hide main content area to focus on combat
                document.querySelector('.content-area').style.display = 'none';
            });
    }

    function closeCombatPanel() {
        document.getElementById('combat-panel-container').style.display = 'none';
        document.querySelector('.content-area').style.display = 'flex';
        currentCombatId = null;
    }

    $(document).ready(function() {
        $('input[name="cp-defense"]').on('change', function() {
            if ($('input[name="cp-defense"]:checked').length > 2) {
                $(this).prop('checked', false);
                alert("Можно выбрать только 2 зоны защиты!");
            }
        });

        $('#cp-btn-hit').on('click', function() {
            const attackZone = $('input[name="cp-attack"]:checked').val();
            const defenseZones = $('input[name="cp-defense"]:checked').map(function() {
                return parseInt($(this).val());
            }).get();

            if (!attackZone || defenseZones.length !== 2) {
                alert("Выберите зону атаки и 2 зоны защиты!");
                return;
            }

            $(this).prop('disabled', true);

            $.ajax({
                url: `/api/combat/${currentCombatId}/turn/`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    attack_zone: attackZone,
                    defense_zones: defenseZones
                }),
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                success: function(response) {
                    updateCPCombatUI(response.state);
                    $('#cp-btn-hit').prop('disabled', response.state.status !== 'active');
                },
                error: function(xhr) {
                    alert(xhr.responseJSON?.error || "Ошибка при выполнении хода");
                    $('#cp-btn-hit').prop('disabled', false);
                }
            });
        });

        $('#cp-btn-flee').on('click', function() {
            if (!confirm("Вы уверены, что хотите сбежать?")) return;

            $.ajax({
                url: `/api/combat/${currentCombatId}/flee/`,
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                success: function(response) {
                    updateCPCombatUI(response.state);
                }
            });
        });
    });

    function updateCPCombatUI(state) {
        const playerHpPercent = (state.player.current_hp / state.player.max_hp) * 100;
        const monsterHpPercent = (state.monster.current_hp / state.monster.max_hp) * 100;

        $('#cp-player-hp-bar').css('width', playerHpPercent + '%');
        $('#cp-player-hp-text').text(`${state.player.current_hp}/${state.player.max_hp}`);
        $('#cp-player-name').text(`${state.player.name} [${state.player.level}]`);
        $('#cp-total-damage-dealt').text(state.player.total_damage_dealt || 0);

        $('#cp-monster-hp-bar').css('width', monsterHpPercent + '%');
        $('#cp-monster-hp-text').text(`${state.monster.current_hp}/${state.monster.max_hp}`);
        $('#cp-monster-name').text(`${state.monster.name} [${state.monster.level}]`);

        $('#cp-combat-log').empty();
        [...state.log].reverse().forEach(entry => {
            $('#cp-combat-log').append(`<div class="log-entry">${entry}</div>`);
        });

        if (state.status !== 'active') {
            $('#cp-combat-controls').hide();
            const msg = state.finish_message || (state.status === 'victory' ? 'Победа!' : 'Поражение');
            $('#cp-combat-log').prepend(`<div class="log-entry" style="color: gold; font-weight: bold;">${msg} <button onclick="closeCombatPanel()">Завершить бой</button></div>`);
        } else {
            $('#cp-combat-controls').show();
        }
    }
</script>
